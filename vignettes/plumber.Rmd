---
title: "stream: Working With Data Streams Over Connections"
author: "Michael Hahsler"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{stream: Working With Data Streams Over Connections}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

`stream` can use the functions `write_stream()` and the class `DSD_ReadStream` for communicate via connections (files, sockets, URLs, etc.). Here is 
a short example of how to set up this communication using sockets.

## Serving a Data Stream

We use library `callr` to create a separate R process that serves a data stream creating 10 points every second
using a socket connection, but
you can also put the code in function `r_bg()` in a file 
called `server.R` and run it with `R CMD BATCH server.R` from the command line.

```{r eval = FALSE}
library(callr)

rp1 <- r_bg(function() {
  library(stream)
  stream <- DSD_Gaussians(k = 3, d = 3)
  blocksize <- 10

  con <- socketConnection(port = 6011, server = TRUE)
  
  while (TRUE) {
    write_stream(stream, con, n = blocksize, close = FALSE)
    Sys.sleep(1)
  }
  
  close(con)
})

rp1
```

## Reading from the Stream

We open the connection which starts the data generating process and then poll
all available data (`n = -1`) several times. The first request should yield 10 points, the second none and the third request should yield 20 points (2 seconds).

```{r eval = FALSE}
library(stream)

con <- socketConnection(port = 6011, open = 'r')
con

dsd <- DSD_ReadStream(con)

get_points(dsd, n= -1, outofpoints = "ignor")
get_points(dsd, n= -1, outofpoints = "ignor")

Sys.sleep(2)
get_points(dsd, n= -1, outofpoints = "ignor")

close(con)
```

## Stoping the Server Process

Here we stop the `callr` process. Note that the socket connection is still active and will serve the data in the connection buffer as long as the reading
process keeps the connection open.

```{r eval = FALSE}
rp1$kill()
rp1
```

